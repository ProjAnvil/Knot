.PHONY: build build-all clean run test deps fmt lint setup package package-all package-cli package-cli-all package-server package-server-all

# Build flags for size optimization
# -s: omit symbol table and debug info
# -w: omit DWARF symbol table
LDFLAGS := -s -w

# Build CLI binary for current platform
build:
	@echo "Building Knot CLI for current platform..."
	@mkdir -p bin
	@go build -ldflags="$(LDFLAGS)" -o bin/knot ./cmd/cli
	@echo ""
	@ls -lh bin/knot | awk '{print "âœ“ Binary: bin/knot (" $$5 ")"}'

# Build CLI binary for all platforms
build-all:
	@echo "Building Knot CLI for all platforms..."
	@mkdir -p bin
	@echo ""
	@echo "Building Linux AMD64..."
	@GOOS=linux GOARCH=amd64 go build -ldflags="$(LDFLAGS)" -o bin/knot-linux ./cmd/cli
	@ls -lh bin/knot-linux | awk '{print "âœ“ bin/knot-linux (" $$5 ")"}'
	@echo ""
	@echo "Building macOS AMD64..."
	@GOOS=darwin GOARCH=amd64 go build -ldflags="$(LDFLAGS)" -o bin/knot-macos-amd64 ./cmd/cli
	@ls -lh bin/knot-macos-amd64 | awk '{print "âœ“ bin/knot-macos-amd64 (" $$5 ")"}'
	@echo ""
	@echo "Building macOS ARM64..."
	@GOOS=darwin GOARCH=arm64 go build -ldflags="$(LDFLAGS)" -o bin/knot-macos-arm64 ./cmd/cli
	@ls -lh bin/knot-macos-arm64 | awk '{print "âœ“ bin/knot-macos-arm64 (" $$5 ")"}'
	@echo ""
	@echo "Building Windows AMD64..."
	@GOOS=windows GOARCH=amd64 go build -ldflags="$(LDFLAGS)" -o bin/knot-windows.exe ./cmd/cli
	@ls -lh bin/knot-windows.exe | awk '{print "âœ“ bin/knot-windows.exe (" $$5 ")"}'
	@echo ""
	@echo "âœ… All CLI binaries built successfully in bin/"

# Run server in development mode
run:
	@go run ./cmd/server/main.go

# Clean build artifacts
clean:
	@rm -rf bin/ internal/embedded/frontend_dist/
	@echo "âœ“ Cleaned build artifacts (bin/, internal/embedded/frontend_dist/)"

# Run tests
test:
	@go test -v ./...

# Install dependencies
deps:
	@go mod download
	@go mod tidy

# Format code
fmt:
	@go fmt ./...

# Run linter
lint:
	@golangci-lint run

# Setup development environment
setup:
	@go mod download
	@mkdir -p bin
	@echo "âœ“ Development environment ready"

# Package both CLI (with frontend) and server (current platform)
package: package-cli package-server
	@echo ""
	@echo "âœ… Complete package built successfully!"
	@echo "   CLI: bin/knot (frontend embedded)"
	@echo "   Server: bin/knot-server (API only)"
	@echo ""
	@echo "To run: ./bin/knot start"

# Package both CLI and server for all platforms
package-all: package-cli-all package-server-all
	@echo ""
	@echo "âœ… All packages built successfully!"
	@echo "   CLI binaries (with embedded frontend): bin/knot-*"
	@echo "   Server binaries (API only): bin/knot-server-*"

# Package CLI with embedded frontend (current platform)
package-cli:
	@echo "ðŸ“¦ Building CLI with embedded frontend for current platform..."
	@echo ""
	@echo "Step 1/3: Building frontend..."
	@cd ../frontend && bun run build
	@echo ""
	@echo "Step 2/3: Copying frontend to internal/embedded/frontend_dist..."
	@rm -rf internal/embedded/frontend_dist
	@mkdir -p internal/embedded/frontend_dist
	@cp -r ../frontend/dist/* internal/embedded/frontend_dist/
	@echo "âœ“ Frontend copied for embedding"
	@echo ""
	@echo "Step 3/3: Building CLI binary (with embedded frontend)..."
	@mkdir -p bin
	@go build -tags embedfrontend -ldflags="$(LDFLAGS)" -o bin/knot ./cmd/cli
	@echo ""
	@ls -lh bin/knot | awk '{print "   Size: " $$5}'
	@echo "âœ… CLI package built successfully!"
	@echo "   bin/knot (frontend embedded in binary)"

# Package CLI with embedded frontend (all platforms)
package-cli-all:
	@echo "ðŸ“¦ Building CLI with embedded frontend for all platforms..."
	@echo ""
	@echo "Step 1/3: Building frontend..."
	@cd ../frontend && bun run build
	@echo ""
	@echo "Step 2/3: Copying frontend to internal/embedded/frontend_dist..."
	@rm -rf internal/embedded/frontend_dist
	@mkdir -p internal/embedded/frontend_dist
	@cp -r ../frontend/dist/* internal/embedded/frontend_dist/
	@echo "âœ“ Frontend copied for embedding"
	@echo ""
	@echo "Step 3/3: Building CLI for all platforms..."
	@mkdir -p bin
	@echo ""
	@echo "Building Linux AMD64..."
	@GOOS=linux GOARCH=amd64 go build -tags embedfrontend -ldflags="$(LDFLAGS)" -o bin/knot-linux ./cmd/cli
	@ls -lh bin/knot-linux | awk '{print "âœ“ bin/knot-linux (" $$5 ")"}'
	@echo ""
	@echo "Building macOS AMD64..."
	@GOOS=darwin GOARCH=amd64 go build -tags embedfrontend -ldflags="$(LDFLAGS)" -o bin/knot-macos-amd64 ./cmd/cli
	@ls -lh bin/knot-macos-amd64 | awk '{print "âœ“ bin/knot-macos-amd64 (" $$5 ")"}'
	@echo ""
	@echo "Building macOS ARM64..."
	@GOOS=darwin GOARCH=arm64 go build -tags embedfrontend -ldflags="$(LDFLAGS)" -o bin/knot-macos-arm64 ./cmd/cli
	@ls -lh bin/knot-macos-arm64 | awk '{print "âœ“ bin/knot-macos-arm64 (" $$5 ")"}'
	@echo ""
	@echo "Building Windows AMD64..."
	@GOOS=windows GOARCH=amd64 go build -tags embedfrontend -ldflags="$(LDFLAGS)" -o bin/knot-windows.exe ./cmd/cli
	@ls -lh bin/knot-windows.exe | awk '{print "âœ“ bin/knot-windows.exe (" $$5 ")"}'
	@echo ""
	@echo "âœ… All CLI packages built successfully in bin/"

# Package server only (current platform)
package-server:
	@echo "ðŸ“¦ Building server binary for current platform..."
	@mkdir -p bin
	@go build -ldflags="$(LDFLAGS)" -o bin/knot-server ./cmd/server
	@echo ""
	@ls -lh bin/knot-server | awk '{print "   Size: " $$5}'
	@echo "âœ… Server package built successfully!"
	@echo "   bin/knot-server (API only, no frontend)"

# Package server only (all platforms)
package-server-all:
	@echo "ðŸ“¦ Building server binary for all platforms..."
	@mkdir -p bin
	@echo ""
	@echo "Building Linux AMD64..."
	@GOOS=linux GOARCH=amd64 go build -ldflags="$(LDFLAGS)" -o bin/knot-server-linux ./cmd/server
	@ls -lh bin/knot-server-linux | awk '{print "âœ“ bin/knot-server-linux (" $$5 ")"}'
	@echo ""
	@echo "Building macOS AMD64..."
	@GOOS=darwin GOARCH=amd64 go build -ldflags="$(LDFLAGS)" -o bin/knot-server-macos-amd64 ./cmd/server
	@ls -lh bin/knot-server-macos-amd64 | awk '{print "âœ“ bin/knot-server-macos-amd64 (" $$5 ")"}'
	@echo ""
	@echo "Building macOS ARM64..."
	@GOOS=darwin GOARCH=arm64 go build -ldflags="$(LDFLAGS)" -o bin/knot-server-macos-arm64 ./cmd/server
	@ls -lh bin/knot-server-macos-arm64 | awk '{print "âœ“ bin/knot-server-macos-arm64 (" $$5 ")"}'
	@echo ""
	@echo "Building Windows AMD64..."
	@GOOS=windows GOARCH=amd64 go build -ldflags="$(LDFLAGS)" -o bin/knot-server-windows.exe ./cmd/server
	@ls -lh bin/knot-server-windows.exe | awk '{print "âœ“ bin/knot-server-windows.exe (" $$5 ")"}'
	@echo ""
	@echo "âœ… All server packages built successfully in bin/"
